{ haskell, latestGit, lib, runCabal2nix }:

with builtins;
with lib;

with rec {
  # Get Stack source
  psrc = latestGit {
    url = "https://github.com/commercialhaskell/stack.git";
    ref = "v1.3.0";
  };

  # Choose a known-good Haskell version
  hsPkgs = haskell.packages.ghc801.override { inherit overrides; };

  # Overrides a Haskell package set with known-good Stack dependencies
  overrides = self: super:
    with rec {
      # Fetches and builds a particular Hackage package
      call  = n: v: extra: self.callPackage (runCabal2nix ({
                                              url = "cabal://${n}-${v}";
                                            } // extra)) {};
    };
    {
      stack = call "" "" {
        url  = psrc;
        args = ["--no-check" "--no-haddock"];
      };

      # Pick known-good dependencies
      aeson                = call "aeson"                "1.0.2.1"  {
        args = [ "--no-check" ];
      };
      aeson-compat         = call "aeson-compat"         "0.3.6"    {};
      base-compat          = call "base-compat"          "0.9.1"    {};
      binary-orphans       = call "binary-orphans"       "0.1.5.1"  {};
      binary-tagged        = call "binary-tagged"        "0.1.4.2"  {};
      clock                = call "clock"                "0.7.2"    {
        args = [ "--no-check" ];
      };
      conduit              = call "conduit"              "1.2.8"    {};
      cryptonite           = call "cryptonite"           "0.20"     {};
      fail                 = call "fail"                 "4.9.0.0"  {
        args = [ "--no-haddock"];
      };
      file-embed           = call "file-embed"           "0.0.10"   {};
      genvalidity          = call "genvalidity"          "0.2.0.4"  {};
      genvalidity-hspec    = call "genvalidity-hspec"    "0.2.0.5"  {};
      hpack                = call "hpack"                "0.15.0"   {};
      http-client          = call "http-client"          "0.5.4"    {};
      http-client-tls      = call "http-client-tls"      "0.3.3"    {};
      http-conduit         = call "http-conduit"         "2.2.3"    {};
      microlens            = call "microlens"            "0.4.2.0"  {
        args = ["--no-haddock"];
      };
      mmorph = call "mmorph" "1.0.9" {};
      monads-tf = call "monads-tf" "0.1.0.3" {};
      monad-unlift = call "monad-unlift" "0.2.0" {};
      mutable-containers = call "mutable-containers" "0.3.3" {};
      optparse-applicative = call "optparse-applicative" "0.13.0.0" {
        args = ["--no-check"];
      };
      path                 = call "path"                 "0.5.11"   {};
      persistent-template  = call "persistent-template"  "2.5.1.6"  {};
      persistent           = call "persistent"           "2.6"      {};
      persistent-sqlite = call "persistent-sqlite" "2.6" {};
      pid1                 = call "pid1"                 "0.1.0.1"  {};
      retry = call "retry" "0.7.4.2" {};
      safe-exceptions      = call "safe-exceptions"      "0.1.4.0"  {};
      scientific           = call "scientific"           "0.3.4.9"  {};
      semigroups           = call "semigroups"           "0.18.2"   {};
      store                = call "store"                "0.3"      {
        args = ["--no-check"];
      };
      tar                  = call "tar"                  "0.5.0.3"  {
        args = ["--no-check"];
      };
      th-expand-syns = call "th-expand-syns" "0.4.1.0" {};
      tls                  = call "tls"                  "1.3.8"    {};
      transformers = call "transformers" "0.5.2.0" {};
      yaml                 = call "yaml"                 "0.8.21.1" {};
      store-core           = call "store-core"           "0.3"      {};
      tasty                = call "tasty"                "0.11.0.4" {};
      text-metrics         = call "text-metrics"         "0.2.0"    {};
      th-reify-many        = call "th-reify-many"        "0.1.6"    {};
      th-utilities         = call "th-utilities"         "0.2.0.1"  {};
      unicode-transforms   = call "unicode-transforms"   "0.2.0"    {};
      validity             = call "validity"             "0.3.0.4"  {};
      weigh                = call "weigh"                "0.0.3"    {};
    };
};

# Extract Stack
hsPkgs.stack
